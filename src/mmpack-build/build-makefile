# vi:syntax=sh

set -e

cd $SRCDIR
export LDFLAGS="-Wl,--as-needed $LDFLAGS"
make $OPTS PREFIX=$PREFIX

if [ "$SKIP_TESTS" != "True" ] ; then
	ld_lib_path=$PREFIX/lib${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}
	if make --silent --dry-run check ; then
		LD_LIBRARY_PATH=$ld_lib_path make check $OPTS PREFIX=$PREFIX
	elif make --silent --dry-run test ; then
		LD_LIBRARY_PATH=$ld_lib_path make test $OPTS PREFIX=$PREFIX
	else
		echo "No test target found" 1>&2
		exit 1
	fi
fi

make install $OPTS PREFIX=$PREFIX DESTDIR=$DESTDIR
