# vi:syntax=sh

set -e

initial_opts='-DCMAKE_BUILD_TYPE=Release -DCMAKE_INTERPROCEDURAL_OPTIMIZATION=TRUE -G"Ninja" -Wno-dev'

cd $BUILDDIR
eval cmake $SRCDIR -DCMAKE_INSTALL_PREFIX:PATH=$PREFIX -DCMAKE_PREFIX_PATH="$PREFIX" $initial_opts $OPTS

# Determine which generator has been used (supports only make and ninja)
if [ -n "$BUILDER" ]; then
	BUILDER=$BUILDER
elif [ -e build.ninja ]; then
	BUILDER=ninja
elif [ -e Makefile ]; then
	BUILDER=make
else
	echo "Could not find builder program" 1>&2
	exit 1
fi

# Execute build
$BUILDER


if [ "$SKIP_TESTS" != "True" ] ; then
	has_test_target=1
	case $BUILDER in
	make)	make -q test > /dev/null 2> /dev/null || has_test_target=0 ;;
	ninja)	grep -q "build test:" build.ninja || has_test_target=0 ;;
	esac

	if [ $has_test_target -eq 1 ] ; then
		ld_lib_path=$PREFIX/lib${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}
		LD_LIBRARY_PATH=$ld_lib_path $BUILDER test
	fi
fi

DESTDIR=$DESTDIR $BUILDER install
